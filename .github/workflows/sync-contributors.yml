name: Update Contributors in README

on:
  workflow_dispatch:
    inputs:
      comment:
        description: 'æ‰‹åŠ¨è§¦å‘å¤‡æ³¨'
        required: false
        default: 'Update contributors list'

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # å…³é”®ä¿®å¤ï¼šç”¨jqç›´æ¥ç”Ÿæˆå®Œæ•´HTMLï¼Œé¿å…å¾ªç¯è¯»å–é”™è¯¯
      - name: Generate contributors HTML (fixed)
        id: gen_contrib
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          
          # è·å–è´¡çŒ®è€…APIæ•°æ®ï¼ˆå¸¦æ—¥å¿—ï¼‰
          echo "ğŸ” Fetching contributors from https://api.github.com/repos/$OWNER/$REPO/contributors?per_page=100"
          CONTRIBUTORS=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            "https://api.github.com/repos/$OWNER/$REPO/contributors?per_page=100")
          
          # ç”¨jqç›´æ¥ç”Ÿæˆå®Œæ•´HTMLå­—ç¬¦ä¸²ï¼ˆæ— å¾ªç¯ï¼Œæ— è¯»å–é”™è¯¯ï¼‰
          CONTRIBUTORS_HTML=$(echo "$CONTRIBUTORS" | jq -r '
            .[] | 
            "<a href=\"\(.html_url)\" target=\"_blank\" rel=\"noopener noreferrer\" title=\"\(.login)\">" +
            "<img src=\"\(.avatar_url)\" alt=\"\(.login)\" width=\"48\" height=\"48\" style=\"border-radius: 50%; margin: 0 8px 8px 0; object-fit: cover;\" />" +
            "</a>"
          ' | tr -d '\n') # ç§»é™¤å¤šä½™æ¢è¡Œï¼Œç´§å‡‘æ˜¾ç¤º
          
          # è°ƒè¯•ï¼šè¾“å‡ºç”Ÿæˆçš„HTMLï¼ˆå‰200å­—ç¬¦ï¼Œé¿å…æ—¥å¿—è¿‡é•¿ï¼‰
          echo "ğŸ“ Generated HTML (preview): ${CONTRIBUTORS_HTML:0:200}..."
          echo "ğŸ“ HTML length: ${#CONTRIBUTORS_HTML} characters"
          
          # å­˜å…¥ç¯å¢ƒå˜é‡ï¼ˆç”¨printfç¡®ä¿ç‰¹æ®Šå­—ç¬¦ä¸è¢«è½¬ä¹‰ï¼‰
          printf "contributors_html=%s" "$CONTRIBUTORS_HTML" >> "$GITHUB_ENV"

      # ç®€åŒ–æ›¿æ¢é€»è¾‘ï¼Œç¡®ä¿å†…å®¹æ­£ç¡®æ’å…¥
      - name: Update README files
        id: update_files
        run: |
          update_readme() {
            local file="$1"
            local start="<!-- readme: contributors -start -->"
            local end="<!-- readme: contributors -end -->"
            
            # æ£€æŸ¥æ–‡ä»¶å’Œæ ‡è®°
            [ ! -f "$file" ] && echo "âš ï¸ $file not found" && return 1
            grep -qxF "$start" "$file" && grep -qxF "$end" "$file" || {
              echo "âŒ $file missing tags" && return 1
            }
            
            # ç”¨awkæ›¿æ¢ï¼šä¿ç•™æ ‡è®°ï¼Œæ’å…¥HTMLï¼ˆå¤„ç†å¤šç©ºè¡Œï¼‰
            awk -v s="$start" -v e="$end" -v c="$contributors_html" '
              BEGIN { in_block=0 }
              $0 == s { print; print c; in_block=1; next }
              $0 == e { in_block=0 }
              !in_block { print }
            ' "$file" > "$file.tmp" && mv "$file.tmp" "$file"
            
            # éªŒè¯æ’å…¥ç»“æœ
            if grep -q "$contributors_html" "$file"; then
              echo "âœ… $file updated successfully"
              return 0
            else
              echo "âŒ Failed to insert content into $file"
              # è¾“å‡ºæ–‡ä»¶ä¸­æ ‡è®°åŒºåŸŸçš„å†…å®¹ï¼Œæ–¹ä¾¿è°ƒè¯•
              echo "ğŸ“‹ Current content between tags in $file:"
              awk -v s="$start" -v e="$end" '
                $0 == s { flag=1; next }
                $0 == e { flag=0 }
                flag { print }
              ' "$file"
              return 1
            fi
          }
          
          # æ‰§è¡Œæ›´æ–°
          if update_readme "README.md" && update_readme "README_zh.md"; then
            echo "update_success=true" >> "$GITHUB_ENV"
          else
            echo "update_success=false" >> "$GITHUB_ENV"
          fi

      - name: Commit changes
        if: env.update_success == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update contributors list"
          file_pattern: "README.md README_zh.md"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      - name: Final result
        run: |
          if [ "${{ env.update_success }}" == "true" ]; then
            echo "ğŸ‰ è´¡çŒ®è€…åˆ—è¡¨æ›´æ–°æˆåŠŸï¼"
          else
            echo "âŒ æ›´æ–°å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—ä¸­çš„ã€ŒCurrent content between tagsã€ä¿¡æ¯"
            exit 1
          fi
