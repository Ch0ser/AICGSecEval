name: Sync Contributors

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate contributors markdown
        run: |
          set -e
          page=1
          : > contributors.json
          # 增加超时和错误处理
          curl --max-time 10 --retry 3 -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
               -H "Accept: application/vnd.github+json" \
               "${{ github.api_url }}/repos/${{ github.repository }}/contributors?per_page=100&page=$page&anon=1" > page.json

          # 检查API是否返回正常（200状态码）
          if ! grep -q '"login"' page.json && ! grep -q '"message": "Not Found"' page.json; then
            echo "Warning: No contributors found or API error"
          fi

          # 循环获取所有贡献者页面（最多50页）
          while [ $page -le 50 ]; do
            # 检查当前页是否为有效数组
            if [ "$(jq 'type' page.json 2>/dev/null)" != '"array"' ]; then
              echo "Stopping at page $page: Not a valid array response"
              break
            fi

            len=$(jq 'length' page.json 2>/dev/null | tr -d '\n\r')
            if [ "$len" -eq 0 ]; then
              echo "Stopping at page $page: Empty page"
              break
            fi

            # 追加当前页数据
            jq -c '.[]' page.json >> contributors.json
            ((page++))
            
            # 获取下一页
            curl --max-time 10 --retry 3 -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github+json" \
                 "${{ github.api_url }}/repos/${{ github.repository }}/contributors?per_page=100&page=$page&anon=1" > page.json
          done

          # 修改：放宽筛选条件，允许没有login的贡献者（匿名）
          # 并增加默认内容，避免空文件
          jq -r '
            select(type=="object") | 
            if .login then "- [@\(.login)](https://github.com/\(.login))" 
            else "- Anonymous Contributor" 
            end
          ' contributors.json | sort -u > contributors.md

          # 确保至少有一条记录
          if [ ! -s contributors.md ]; then
            echo "- No contributors found" > contributors.md
          fi

          echo "Generated contributors list:"
          cat contributors.md

      - name: Inject into README.md
        run: |
          # 增强正则匹配，允许标签前后有空白
          perl -0777 -pe '
            s/(<!--\s+readme: contributors -start\s+-->).*?(<!--\s+readme: contributors -end\s+-->)/$1\n'"$(cat contributors.md)"'\n$2/s
          ' README.md > README.md.tmp && mv README.md.tmp README.md

      - name: Inject into README_zh.md
        run: |
          # 增强正则匹配，允许标签前后有空白
          perl -0777 -pe '
            s/(<!--\s+readme: contributors -start\s+-->).*?(<!--\s+readme: contributors -end\s+-->)/$1\n'"$(cat contributors.md)"'\n$2/s
          ' README_zh.md > README_zh.md.tmp && mv README_zh.md.tmp README_zh.md

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md README_zh.md
          # 即使内容是默认的"No contributors found"也提交
          git diff --cached --quiet || (
            git commit -m "docs: sync contributors [skip ci]" && git push
          )
          # 强制提交（如果需要，取消下面一行的注释）
          # git commit -m "docs: sync contributors [skip ci]" && git push || true
