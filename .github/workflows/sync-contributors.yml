name: Update Contributors in README

# 触发条件：可以根据需要调整
on:
  # 1. 定时触发（每周一凌晨运行）
  schedule:
    - cron: '0 0 * * 1'
  # 2. 手动触发
  workflow_dispatch:
  # 3. 当有新的贡献者加入时（push到main分支时触发）
  push:
    branches: [ main, master ]
    paths-ignore: # 忽略README文件本身的变更，避免循环触发
      - 'README.md'
      - 'README_zh.md'

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    steps:
      # 步骤1：检出仓库代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 确保能获取完整的贡献者信息

      # 步骤2：安装必要依赖（jq用于JSON处理）
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      # 步骤3：生成贡献者HTML内容
      - name: Generate contributors content
        id: generate_contributors
        run: |
          # 获取仓库所有者和仓库名（从GitHub环境变量中获取）
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          
          # 使用GitHub API获取贡献者信息（按贡献次数排序，取前100名）
          CONTRIBUTORS=$(curl -s "https://api.github.com/repos/$OWNER/$REPO/contributors?per_page=100" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json")
          
          # 生成HTML格式的贡献者列表（头像+链接）
          CONTRIBUTORS_HTML=""
          echo "$CONTRIBUTORS" | jq -r '.[] | .login, .avatar_url, .html_url' | while read -r login; do
            read -r avatar_url
            read -r html_url
            
            # 头像样式：统一大小为48px，圆形，间距8px
            CONTRIBUTORS_HTML+="<a href=\"$html_url\" target=\"_blank\" rel=\"noopener noreferrer\" title=\"$login\">"
            CONTRIBUTORS_HTML+="<img src=\"$avatar_url\" alt=\"$login\" width=\"48\" height=\"48\" style=\"border-radius: 50%; margin: 0 8px 8px 0;\" />"
            CONTRIBUTORS_HTML+="</a>"
          done
          
          # 将生成的HTML内容存入环境变量，供后续步骤使用
          echo "contributors_html<<EOF" >> "$GITHUB_ENV"
          echo "$CONTRIBUTORS_HTML" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      # 步骤4：替换README.md和README_zh.md中的贡献者区域
      - name: Update README files
        run: |
          # 定义替换函数
          update_readme() {
            local file="$1"
            local start_comment="<!-- readme: contributors -start -->"
            local end_comment="<!-- readme: contributors -end -->"
            
            # 检查文件是否存在
            if [ ! -f "$file" ]; then
              echo "警告：$file 不存在，跳过更新"
              return
            fi
            
            # 使用sed命令替换两个注释之间的内容（兼容Linux/macOS）
            # 注意：如果是macOS，需要将sed命令中的 -i 改为 -i ''
            sed -i.bak "s|$start_comment.*$end_comment|$start_comment\n\n$contributors_html\n\n$end_comment|g" "$file"
            
            # 删除备份文件
            rm -f "$file.bak"
            
            echo "成功更新 $file 中的贡献者信息"
          }
          
          # 执行替换
          update_readme "README.md"
          update_readme "README_zh.md"

      # 步骤5：提交更改到仓库
      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          # 提交信息
          commit_message: "docs: update contributors list"
          # 只提交两个README文件
          file_pattern: "README.md README_zh.md"
          # 提交者信息（可自定义）
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
