name: Sync Contributors

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate contributors markdown
        run: |
          set -e
          page=1
          : > contributors.json
          while [ $page -le 50 ]; do
            curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github+json" \
                 "${{ github.api_url }}/repos/${{ github.repository }}/contributors?per_page=100&page=$page&anon=1" > page.json

            [ "$(jq 'type' page.json 2>/dev/null)" != '"array"' ] && break

            len=$(jq 'length' page.json 2>/dev/null | tr -d '\n\r')
            [ "$len" = "0" ] && break

            jq -c '.[]' page.json >> contributors.json
            ((page++))
          done

          # 生成贡献者列表并转义特殊字符
          jq -r 'select(type=="object" and .login) | "- [@\(.login)](https://github.com/\(.login))"' contributors.json 2>/dev/null \
          | sort -u \
          | sed 's/[\\/&]/\\&/g' > contributors.md  # 关键修复：转义Perl特殊字符

          # 确保文件不为空
          if [ ! -s contributors.md ]; then
            echo "- [@$(echo ${{ github.repository }} | cut -d/ -f1 | sed 's/[\\/&]/\\&/g')](https://github.com/$(echo ${{ github.repository }} | cut -d/ -f1))" > contributors.md
          fi

          echo "Generated contributors list:"
          cat contributors.md

      - name: Inject into README.md
        run: |
          # 使用文件读取方式避免命令行参数注入问题
          perl -0777 -pe '
            open my $fh, "<", "contributors.md" or die $!;
            local $/;
            my $contributors = <$fh>;
            close $fh;
            s/(<!-- readme: contributors -start -->).*?(<!-- readme: contributors -end -->)/$1\n$contributors\n$2/s
          ' README.md > README.md.tmp && mv README.md.tmp README.md

      - name: Inject into README_zh.md
        run: |
          # 同样优化中文README的注入方式
          perl -0777 -pe '
            open my $fh, "<", "contributors.md" or die $!;
            local $/;
            my $contributors = <$fh>;
            close $fh;
            s/(<!-- readme: contributors -start -->).*?(<!-- readme: contributors -end -->)/$1\n$contributors\n$2/s
          ' README_zh.md > README_zh.md.tmp && mv README_zh.md.tmp README_zh.md

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md README_zh.md
          git diff --cached --quiet || (
            git commit -m "docs: sync contributors [skip ci]" && git push
          )
