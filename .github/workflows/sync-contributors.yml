name: Update Contributors in README

on:
  workflow_dispatch:
    inputs:
      comment:
        description: 'æ‰‹åŠ¨è§¦å‘å¤‡æ³¨'
        required: false
        default: 'Update contributors list'

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Install dependencies (jq + perl)
        run: sudo apt-get update && sudo apt-get install -y jq perl

      # æ­¥éª¤1ï¼šç”ŸæˆHTMLå¹¶å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼ˆé¿å…å˜é‡ä¼ é€’æˆªæ–­ï¼‰
      - name: Generate contributors HTML
        id: gen_contrib
        run: |
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          
          # è·å–è´¡çŒ®è€…æ•°æ®
          CONTRIBUTORS=$(curl -s -H "Authorization: Bearer ${{ github.token }}" \
            "https://api.github.com/repos/$OWNER/$REPO/contributors?per_page=100")
          
          # ç”¨jqç”ŸæˆHTMLå¹¶å†™å…¥ä¸´æ—¶æ–‡ä»¶ï¼ˆæ— å˜é‡é•¿åº¦é™åˆ¶ï¼‰
          echo "$CONTRIBUTORS" | jq -r '
            .[] | 
            "<a href=\"\(.html_url)\" target=\"_blank\" rel=\"noopener noreferrer\" title=\"\(.login)\">" +
            "<img src=\"\(.avatar_url)\" alt=\"\(.login)\" width=\"48\" height=\"48\" style=\"border-radius: 50%; margin: 0 8px 8px 0; object-fit: cover;\" />" +
            "</a>"
          ' | tr -d '\n' > /tmp/contributors.html
          
          # éªŒè¯ä¸´æ—¶æ–‡ä»¶ï¼ˆç¡®ä¿éç©ºï¼‰
          HTML_SIZE=$(stat -c%s /tmp/contributors.html)
          echo "ğŸ“ HTML file size: $HTML_SIZE bytes"
          [ $HTML_SIZE -eq 0 ] && echo "âŒ HTML is empty" && exit 1

      # æ­¥éª¤2ï¼šç”¨perlæ›¿æ¢ï¼ˆæ”¯æŒé•¿å­—ç¬¦ä¸²+ç²¾å‡†å¤šè¡ŒåŒ¹é…ï¼‰
      - name: Update README files (perl replacement)
        id: update_files
        run: |
          update_readme() {
            local file="$1"
            local start="<!-- readme: contributors -start -->"
            local end="<!-- readme: contributors -end -->"
            
            # æ£€æŸ¥æ–‡ä»¶å’Œæ ‡è®°
            [ ! -f "$file" ] && echo "âš ï¸ $file not found" && return 1
            if ! grep -qF "$start" "$file" || ! grep -qF "$end" "$file"; then
              echo "âŒ $file missing tags (start/end)"
              grep -nF "$start\|$end" "$file" || echo "   Tags not found at all"
              return 1
            fi
            
            # æ ¸å¿ƒï¼šç”¨perlè¿›è¡Œå¤šè¡Œæ›¿æ¢ï¼ˆæ”¯æŒé•¿å­—ç¬¦ä¸²ï¼Œæ— æˆªæ–­ï¼‰
            perl -0777 -i.bak -pe "
              s|$start\n.*?$end|$start\n$(cat /tmp/contributors.html)\n$end|gs
            " "$file"
            
            # åˆ é™¤å¤‡ä»½æ–‡ä»¶
            rm -f "$file.bak"
            
            # éªŒè¯æ›¿æ¢ç»“æœï¼ˆæ£€æŸ¥æ ‡è®°ä¹‹é—´æ˜¯å¦éç©ºï¼‰
            CONTENT_BETWEEN_TAGS=$(awk -v s="$start" -v e="$end" '
              $0 == s { flag=1; next }
              $0 == e { flag=0 }
              flag { print }
            ' "$file")
            
            if [ -n "$CONTENT_BETWEEN_TAGS" ]; then
              echo "âœ… $file updated successfully"
              echo "ğŸ“‹ Content between tags (preview): ${CONTENT_BETWEEN_TAGS:0:100}..."
              return 0
            else
              echo "âŒ $file update failed: content between tags is empty"
              return 1
            fi
          }
          
          # æ‰§è¡Œæ›´æ–°
          if update_readme "README.md" && update_readme "README_zh.md"; then
            echo "update_success=true" >> "$GITHUB_ENV"
          else
            echo "update_success=false" >> "$GITHUB_ENV"
          fi

      - name: Commit changes
        if: env.update_success == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update contributors list"
          file_pattern: "README.md README_zh.md"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      - name: Final result
        run: |
          if [ "${{ env.update_success }}" == "true" ]; then
            echo "ğŸ‰ è´¡çŒ®è€…åˆ—è¡¨æ›´æ–°æˆåŠŸï¼"
          else
            echo "âŒ æ›´æ–°å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—ä¸­çš„ã€ŒContent between tagsã€ä¿¡æ¯"
            exit 1
          fi
