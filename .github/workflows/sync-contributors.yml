name: Update Contributors in README

on:
  workflow_dispatch:
    inputs:
      comment:
        description: 'æ‰‹åŠ¨è§¦å‘å¤‡æ³¨'
        required: false
        default: 'Update contributors list'

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Install dependencies (jq + perl)
        run: sudo apt-get update && sudo apt-get install -y jq perl

      # å…³é”®ä¿®å¤ï¼šç¡®ä¿è·å–å…¨éƒ¨è´¡çŒ®è€…ï¼ˆæœ€å¤š100ä¸ªï¼‰
      - name: Generate contributors HTML (full list)
        id: gen_contrib
        run: |
          set -euo pipefail
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          # æ˜ç¡®è®¾ç½® per_page=100ï¼ˆGitHub API æœ€å¤§æ”¯æŒ100ï¼Œæ»¡è¶³30ä¸ªéœ€æ±‚ï¼‰
          API_URL="https://api.github.com/repos/$OWNER/$REPO/contributors?per_page=100"
          
          echo "ğŸ” Fetching all contributors from $API_URL"
          # curl å®Œæ•´è¯·æ±‚ï¼šå¸¦çŠ¶æ€ç æ ¡éªŒ+é•¿è¿æ¥ä¼˜åŒ–
          RESPONSE=$(curl -s -w "%{http_code}" -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json" -L "$API_URL")
          HTTP_CODE=$(echo "$RESPONSE" | tail -c 4)
          CONTRIBUTORS=$(echo "$RESPONSE" | head -c -4)
          
          # æ ¡éªŒAPIå“åº”
          if [ "$HTTP_CODE" -ne 200 ]; then
            echo "âŒ API request failed (HTTP $HTTP_CODE)"
            exit 1
          fi
          if ! echo "$CONTRIBUTORS" | jq . > /dev/null 2>&1; then
            echo "âŒ Invalid JSON response"
            exit 1
          fi
          
          # ç»Ÿè®¡è·å–åˆ°çš„è´¡çŒ®è€…æ•°é‡ï¼ˆå…³é”®éªŒè¯ï¼‰
          CONTRIBUTOR_COUNT=$(echo "$CONTRIBUTORS" | jq '. | length')
          echo "ğŸ“Š Fetched $CONTRIBUTOR_COUNT contributors (expected 30)"
          
          # ç”ŸæˆHTMLï¼ˆç¡®ä¿æ— è¿‡æ»¤ï¼Œå…¨éƒ¨è¾“å‡ºï¼‰
          echo "$CONTRIBUTORS" | jq -r '
            .[] | # æ— ä»»ä½•è¿‡æ»¤ï¼Œè¾“å‡ºæ‰€æœ‰è´¡çŒ®è€…
            "<a href=\"\(.html_url)\" target=\"_blank\" rel=\"noopener noreferrer\" title=\"\(.login)\">" +
            "<img src=\"\(.avatar_url)\" alt=\"\(.login)\" width=\"48\" height=\"48\" style=\"border-radius: 50%; margin: 0 8px 8px 0; object-fit: cover;\" />" +
            "</a>"
          ' | tr -d '\n' > /tmp/contributors.html
          
          # éªŒè¯HTMLåŒ…å«çš„è´¡çŒ®è€…æ•°é‡ï¼ˆé€šè¿‡è®¡æ•°<a>æ ‡ç­¾ï¼‰
          HTML_CONTRIB_COUNT=$(grep -o "<a href=" /tmp/contributors.html | wc -l)
          echo "ğŸ“ HTML contains $HTML_CONTRIB_COUNT contributor entries"
          
          if [ "$HTML_CONTRIB_COUNT" -ne "$CONTRIBUTOR_COUNT" ]; then
            echo "âš ï¸ Mismatch: API returned $CONTRIBUTOR_COUNT, HTML has $HTML_CONTRIB_COUNT"
          fi
          if [ "$HTML_CONTRIB_COUNT" -lt 30 ]; then
            echo "âŒ Not enough contributors in HTML (need 30, got $HTML_CONTRIB_COUNT)"
            exit 1
          fi

      - name: Update README files (perl replacement)
        id: update_files
        run: |
          update_readme() {
            local file="$1"
            local start="<!-- readme: contributors -start -->"
            local end="<!-- readme: contributors -end -->"
            
            [ ! -f "$file" ] && echo "âš ï¸ $file not found" && return 1
            if ! grep -qF "$start" "$file" || ! grep -qF "$end" "$file"; then
              echo "âŒ $file missing tags" && return 1
            fi
            
            # Perlæ›¿æ¢ï¼ˆç¡®ä¿å®Œæ•´å†™å…¥é•¿HTMLï¼‰
            perl -0777 -i.bak -pe "
              s|$start\n.*?$end|$start\n$(cat /tmp/contributors.html)\n$end|gs
            " "$file"
            rm -f "$file.bak"
            
            # éªŒè¯æœ€ç»ˆå†™å…¥çš„æ•°é‡
            FINAL_COUNT=$(grep -o "<a href=" "$file" | wc -l)
            echo "âœ… $file updated: $FINAL_COUNT contributors added"
            return 0
          }
          
          if update_readme "README.md" && update_readme "README_zh.md"; then
            echo "update_success=true" >> "$GITHUB_ENV"
          else
            echo "update_success=false" >> "$GITHUB_ENV"
          fi

      - name: Commit changes
        if: env.update_success == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update contributors list (full 30+ entries)"
          file_pattern: "README.md README_zh.md"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"

      - name: Final result
        run: |
          if [ "${{ env.update_success }}" == "true" ]; then
            echo "ğŸ‰ è´¡çŒ®è€…åˆ—è¡¨æ›´æ–°æˆåŠŸï¼å…±å±•ç¤º $CONTRIBUTOR_COUNT åè´¡çŒ®è€…"
          else
            echo "âŒ æ›´æ–°å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—"
            exit 1
          fi
