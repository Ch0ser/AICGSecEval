name: Sync Contributors

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate contributors markdown
        run: |
          set -e
          page=1
          : > contributors.json
          
          # 完整遍历所有贡献者分页（最多10页避免无限循环）
          while [ $page -le 10 ]; do
            # 调用 API 时移除 anon=1 参数，确保获取全部贡献者
            curl -s -w "HTTP_STATUS:%{http_code}" \
                 -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github+json" \
                 "${{ github.api_url }}/repos/${{ github.repository }}/contributors?per_page=100&page=$page" > page_with_status.json
            
            # 提取 HTTP 状态码和响应体
            HTTP_STATUS=$(grep -o 'HTTP_STATUS:[0-9]*' page_with_status.json | cut -d: -f2)
            sed 's/HTTP_STATUS:[0-9]*//' page_with_status.json > page.json
            
            # 处理 API 错误
            if [ "$HTTP_STATUS" -ne 200 ]; then
              echo "API 错误，状态码: $HTTP_STATUS"
              cat page.json
              break
            fi

            # 验证响应格式
            if [ "$(jq 'type' page.json 2>/dev/null)" != '"array"' ]; then
              echo "响应格式错误，停止抓取"
              break
            fi

            len=$(jq 'length' page.json | tr -d '\n\r')
            echo "第 $page 页获取到 $len 个贡献者"
            if [ "$len" -eq 0 ]; then
              break  # 没有更多贡献者
            fi

            # 追加到总列表
            jq -c '.[]' page.json >> contributors.json
            ((page++))
          done

          # 生成带头像的贡献者列表
          # 格式：[![Avatar](https://github.com/{login}.png?size=24) @{login}](https://github.com/{login})
          jq -r 'select(type=="object" and .login) | 
                 "- [![Avatar](https://github.com/\(.login).png?size=24) @\(.login)](https://github.com/\(.login))"' \
          contributors.json 2>/dev/null | sort -u > contributors.md

          # 容错处理：如果没有获取到贡献者，至少显示仓库所有者
          if [ ! -s contributors.md ]; then
            owner=$(echo ${{ github.repository }} | cut -d/ -f1)
            echo "- [![Avatar](https://github.com/$owner.png?size=24) @$owner](https://github.com/$owner)" > contributors.md
          fi

          echo "生成的贡献者列表："
          cat contributors.md

      - name: Inject into README.md
        run: |
          # 使用文件读取方式避免特殊字符问题
          perl -0777 -pe '
            open my $fh, "<", "contributors.md" or die $!;
            local $/;
            my $contributors = <$fh>;
            close $fh;
            s/(<!-- readme: contributors -start -->).*?(<!-- readme: contributors -end -->)/$1\n$contributors\n$2/s
          ' README.md > README.md.tmp && mv README.md.tmp README.md

      - name: Inject into README_zh.md
        run: |
          perl -0777 -pe '
            open my $fh, "<", "contributors.md" or die $!;
            local $/;
            my $contributors = <$fh>;
            close $fh;
            s/(<!-- readme: contributors -start -->).*?(<!-- readme: contributors -end -->)/$1\n$contributors\n$2/s
          ' README_zh.md > README_zh.md.tmp && mv README_zh.md.tmp README_zh.md

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md README_zh.md
          git diff --cached --quiet || (
            git commit -m "docs: sync contributors with avatars [skip ci]" && git push
          )
