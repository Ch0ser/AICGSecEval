name: Update Contributors in README

# ä»…ä¿ç•™æ‰‹åŠ¨è§¦å‘ï¼ˆç§»é™¤å®šæ—¶å’Œpushè§¦å‘ï¼‰
on:
  workflow_dispatch:
    inputs:
      # å¯é€‰ï¼šæ·»åŠ æ‰‹åŠ¨è§¦å‘æ—¶çš„å¤‡æ³¨è¾“å…¥
      comment:
        description: 'æ‰‹åŠ¨è§¦å‘æ›´æ–°è´¡çŒ®è€…åˆ—è¡¨çš„å¤‡æ³¨'
        required: false
        default: 'Update contributors list manually'

jobs:
  update-contributors:
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç ï¼ˆç¡®ä¿è·å–å®Œæ•´å†å²å’Œåˆ†æ”¯ï¼‰
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.ref }} # ç¡®ä¿æ£€å‡ºå½“å‰åˆ†æ”¯

      # æ­¥éª¤2ï¼šå®‰è£…ä¾èµ–ï¼ˆjqç”¨äºJSONå¤„ç†ï¼‰
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq

      # æ­¥éª¤3ï¼šè·å–å¹¶éªŒè¯è´¡çŒ®è€…ä¿¡æ¯ï¼ˆæ·»åŠ è¯¦ç»†æ—¥å¿—ï¼‰
      - name: Fetch and verify contributors
        id: fetch_contributors
        run: |
          # è·å–ä»“åº“ä¿¡æ¯
          OWNER="${{ github.repository_owner }}"
          REPO="${{ github.event.repository.name }}"
          echo "ğŸ“Œ æ­£åœ¨è·å– $OWNER/$REPO çš„è´¡çŒ®è€…ä¿¡æ¯"
          
          # è°ƒç”¨GitHub APIè·å–è´¡çŒ®è€…ï¼ˆæ·»åŠ è°ƒè¯•æ—¥å¿—ï¼‰
          echo "ğŸ” è°ƒç”¨GitHub APIï¼šhttps://api.github.com/repos/$OWNER/$REPO/contributors?per_page=100"
          CONTRIBUTORS=$(curl -s -v "https://api.github.com/repos/$OWNER/$REPO/contributors?per_page=100" \
            -H "Authorization: Bearer ${{ github.token }}" \
            -H "Accept: application/vnd.github.v3+json")
          
          # éªŒè¯APIå“åº”
          if [ -z "$CONTRIBUTORS" ] || [ "$CONTRIBUTORS" == "[]" ]; then
            echo "âš ï¸ æœªè·å–åˆ°è´¡çŒ®è€…ä¿¡æ¯ï¼ˆå¯èƒ½ä»“åº“æ— è´¡çŒ®è€…æˆ–APIè°ƒç”¨å¤±è´¥ï¼‰"
            echo "contributors_html=<!-- æš‚æ— è´¡çŒ®è€…ä¿¡æ¯ -->" >> "$GITHUB_ENV"
            exit 0
          fi
          
          # æ˜¾ç¤ºè·å–åˆ°çš„è´¡çŒ®è€…æ•°é‡ï¼ˆè°ƒè¯•ç”¨ï¼‰
          CONTRIBUTOR_COUNT=$(echo "$CONTRIBUTORS" | jq '. | length')
          echo "âœ… æˆåŠŸè·å–åˆ° $CONTRIBUTOR_COUNT åè´¡çŒ®è€…"
          
          # ç”ŸæˆHTMLæ ¼å¼çš„è´¡çŒ®è€…åˆ—è¡¨ï¼ˆä¼˜åŒ–æ ¼å¼ï¼‰
          CONTRIBUTORS_HTML=""
          echo "$CONTRIBUTORS" | jq -r '.[] | .login, .avatar_url, .html_url' | while read -r login; do
            read -r avatar_url
            read -r html_url
            
            # ç”Ÿæˆå•ä¸ªè´¡çŒ®è€…çš„HTMLï¼ˆå¢åŠ å…¼å®¹æ€§ï¼‰
            CONTRIBUTOR_ITEM="<a href=\"$html_url\" target=\"_blank\" rel=\"noopener noreferrer\" title=\"$login\">"
            CONTRIBUTOR_ITEM+="<img src=\"$avatar_url\" alt=\"$login\" width=\"48\" height=\"48\" style=\"border-radius: 50%; margin: 0 8px 8px 0; object-fit: cover;\" />"
            CONTRIBUTOR_ITEM+="</a>"
            
            CONTRIBUTORS_HTML+="$CONTRIBUTOR_ITEM"
          done
          
          # è¾“å‡ºç”Ÿæˆçš„HTMLï¼ˆè°ƒè¯•ç”¨ï¼Œé¿å…è¿‡é•¿ï¼‰
          echo "ğŸ“ ç”Ÿæˆçš„è´¡çŒ®è€…HTMLé•¿åº¦ï¼š${#CONTRIBUTORS_HTML} å­—ç¬¦"
          echo "contributors_html<<EOF" >> "$GITHUB_ENV"
          echo "$CONTRIBUTORS_HTML" >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

      # æ­¥éª¤4ï¼šæ›¿æ¢READMEæ–‡ä»¶ï¼ˆä¿®å¤æ ¸å¿ƒé—®é¢˜ï¼‰
      - name: Update README files (fixed replacement)
        id: update_readme
        run: |
          # å®šä¹‰æ›¿æ¢å‡½æ•°ï¼ˆä½¿ç”¨æ›´å¯é çš„å¤šè¡Œæ›¿æ¢ï¼‰
          update_readme() {
            local file="$1"
            local start_tag="<!-- readme: contributors -start -->"
            local end_tag="<!-- readme: contributors -end -->"
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ ! -f "$file" ]; then
              echo "âš ï¸ $file ä¸å­˜åœ¨ï¼Œè·³è¿‡"
              return 1
            fi
            
            # æ£€æŸ¥æ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«ç›®æ ‡æ ‡è®°
            if ! grep -qxF "$start_tag" "$file" || ! grep -qxF "$end_tag" "$file"; then
              echo "âŒ $file ä¸­æœªæ‰¾åˆ°å®Œæ•´çš„æ ‡è®°ï¼š"
              echo "   éœ€è¦åŒæ—¶åŒ…å«ï¼š"
              echo "   $start_tag"
              echo "   $end_tag"
              grep -n "$start_tag\|$end_tag" "$file" || echo "   æ ‡è®°å®Œå…¨æœªæ‰¾åˆ°"
              return 1
            fi
            
            # ä½¿ç”¨awkè¿›è¡Œå¤šè¡Œæ›¿æ¢ï¼ˆè§£å†³sedå¤šè¡ŒåŒ¹é…é—®é¢˜ï¼‰
            # æ ¸å¿ƒé€»è¾‘ï¼šæ‰¾åˆ°start_tagåï¼Œæ›¿æ¢åˆ°end_tagä¹‹é—´çš„æ‰€æœ‰å†…å®¹
            awk -v start="$start_tag" -v end="$end_tag" -v content="$contributors_html" '
              BEGIN { in_block = 0 }
              $0 == start {
                print $0
                print ""  # ç©ºè¡Œåˆ†éš”
                print content
                print ""  # ç©ºè¡Œåˆ†éš”
                in_block = 1
                next
              }
              $0 == end {
                in_block = 0
              }
              !in_block { print $0 }
            ' "$file" > "$file.tmp"
            
            # æ›¿æ¢åŸæ–‡ä»¶
            mv "$file.tmp" "$file"
            
            # éªŒè¯æ›¿æ¢ç»“æœ
            if grep -q "$contributors_html" "$file"; then
              echo "âœ… $file æ›¿æ¢æˆåŠŸ"
              return 0
            else
              echo "âŒ $file æ›¿æ¢å¤±è´¥ï¼Œæœªæ‰¾åˆ°æ’å…¥çš„å†…å®¹"
              return 1
            fi
          }
          
          # æ‰§è¡Œæ›¿æ¢ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
          if update_readme "README.md" && update_readme "README_zh.md"; then
            echo "ğŸ“Š æ‰€æœ‰READMEæ–‡ä»¶æ›´æ–°å®Œæˆ"
            echo "update_success=true" >> "$GITHUB_ENV"
          else
            echo "âŒ éƒ¨åˆ†æ–‡ä»¶æ›´æ–°å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ—¥å¿—"
            echo "update_success=false" >> "$GITHUB_ENV"
          fi

      # æ­¥éª¤5ï¼šä»…å½“æ›´æ–°æˆåŠŸæ—¶æäº¤æ›´æ”¹
      - name: Commit and push changes
        if: env.update_success == 'true'
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: update contributors list"
          file_pattern: "README.md README_zh.md"
          commit_user_name: "github-actions[bot]"
          commit_user_email: "github-actions[bot]@users.noreply.github.com"
          commit_author: "github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
          push_options: "--force-with-lease" # é¿å…å†²çª

      # æ­¥éª¤6ï¼šè¾“å‡ºç»“æœæ‘˜è¦
      - name: Show final result
        run: |
          if [ "${{ env.update_success }}" == "true" ]; then
            echo "ğŸ‰ è´¡çŒ®è€…åˆ—è¡¨æ›´æ–°å®Œæˆï¼"
            echo "ğŸ“‹ è¯·æŸ¥çœ‹README.mdå’ŒREADME_zh.mdä¸­çš„å˜æ›´"
          else
            echo "âŒ è´¡çŒ®è€…åˆ—è¡¨æ›´æ–°å¤±è´¥ï¼"
            echo "ğŸ” è¯·æ£€æŸ¥ï¼š"
            echo "   1. READMEæ–‡ä»¶ä¸­æ˜¯å¦åŒ…å«æ­£ç¡®çš„æ ‡è®°"
            echo "   2. ä»“åº“æ˜¯å¦æœ‰è´¡çŒ®è€…ä¿¡æ¯"
            echo "   3. æŸ¥çœ‹ä¸Šæ–¹æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯"
          fi
