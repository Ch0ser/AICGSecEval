name: Sync Contributors

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate contributors markdown
        run: |
          set -e
          page=1
          : > contributors.json
          API_URL="${{ github.api_url }}/repos/${{ github.repository }}/contributors"
          echo "使用的贡献者API地址: $API_URL"  # 调试：打印API地址确认是否正确

          # 完整遍历所有贡献者分页（最多10页避免无限循环）
          while [ $page -le 10 ]; do
            echo "正在获取第 $page 页贡献者..."
            # 调用API，增加--fail参数让curl在HTTP错误时返回非0退出码，同时保留状态码输出
            curl -s -w "HTTP_STATUS:%{http_code}" \
                 --fail \
                 -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github.v3+json" \  # 明确指定v3版本，兼容性更好
                 "$API_URL?per_page=100&page=$page" > page_with_status.json
            
            # 检查curl是否成功发起请求（非网络层面错误）
            CURL_EXIT_CODE=$?
            if [ $CURL_EXIT_CODE -ne 0 ]; then
              echo "curl请求失败，退出码: $CURL_EXIT_CODE"
              cat page_with_status.json  # 打印可能的错误信息
              break
            fi

            # 提取HTTP状态码和响应体
            HTTP_STATUS=$(grep -o 'HTTP_STATUS:[0-9]*' page_with_status.json | cut -d: -f2)
            sed 's/HTTP_STATUS:[0-9]*//' page_with_status.json > page.json
            
            # 处理API错误状态码
            if [ "$HTTP_STATUS" -ne 200 ]; then
              echo "API返回错误状态码: $HTTP_STATUS"
              cat page.json  # 打印API返回的错误详情
              break
            fi

            # 验证响应体是否为空
            if [ ! -s page.json ]; then
              echo "第 $page 页响应体为空，停止抓取"
              break
            fi

            # 验证响应格式是否为数组
            if [ "$(jq 'type' page.json 2>/dev/null)" != '"array"' ]; then
              echo "第 $page 页响应格式错误，不是JSON数组"
              cat page.json
              break
            fi

            len=$(jq 'length' page.json | tr -d '\n\r')
            echo "第 $page 页获取到 $len 个贡献者"
            if [ "$len" -eq 0 ]; then
              break  # 没有更多贡献者
            fi

            # 追加到总列表
            jq -c '.[]' page.json >> contributors.json
            ((page++))
          done

          # 生成带头像的贡献者列表（移除@用户名）
          jq -r 'select(type=="object" and .login) | 
                 "- [![Avatar](https://github.com/\(.login).png?size=24)](https://github.com/\(.login))"' \
          contributors.json 2>/dev/null | sort -u > contributors.md

          # 容错处理：如果没有获取到贡献者，至少显示仓库所有者
          if [ ! -s contributors.md ]; then
            owner=$(echo ${{ github.repository }} | cut -d/ -f1)
            echo "- [![Avatar](https://github.com/$owner.png?size=24)](https://github.com/$owner)" > contributors.md
            echo "未获取到贡献者，使用仓库所有者: $owner"
          fi

          echo "生成的贡献者列表："
          cat contributors.md

      - name: Inject into README.md
        run: |
          perl -0777 -pe '
            open my $fh, "<", "contributors.md" or die $!;
            local $/;
            my $contributors = <$fh>;
            close $fh;
            s/(<!-- readme: contributors -start -->).*?(<!-- readme: contributors -end -->)/$1\n$contributors\n$2/s
          ' README.md > README.md.tmp && mv README.md.tmp README.md

      - name: Inject into README_zh.md
        run: |
          perl -0777 -pe '
            open my $fh, "<", "contributors.md" or die $!;
            local $/;
            my $contributors = <$fh>;
            close $fh;
            s/(<!-- readme: contributors -start -->).*?(<!-- readme: contributors -end -->)/$1\n$contributors\n$2/s
          ' README_zh.md > README_zh.md.tmp && mv README_zh.md.tmp README_zh.md

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md README_zh.md
          git diff --cached --quiet || (
            git commit -m "docs: sync contributors with avatars [skip ci]" && git push
          )
