name: Sync Contributors

on:
  workflow_dispatch:

permissions:
  contents: write
  # 新增必要权限：读取仓库贡献者信息
  contributors: read

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate contributors markdown
        run: |
          set -e
          page=1
          : > contributors.json
          
          # 增加 API 响应调试
          echo "Fetching contributors from ${{ github.api_url }}/repos/${{ github.repository }}/contributors"
          
          while [ $page -le 50 ]; do
            # 修复 API 调用：移除可能无效的 anon=1 参数，增加错误捕获
            curl -s -w "HTTP_STATUS:%{http_code}" \
                 -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                 -H "Accept: application/vnd.github+json" \
                 "${{ github.api_url }}/repos/${{ github.repository }}/contributors?per_page=100&page=$page" > page_with_status.json
            
            # 分离状态码和响应体
            grep -o 'HTTP_STATUS:[0-9]*' page_with_status.json > status.tmp
            HTTP_STATUS=$(cat status.tmp | cut -d: -f2)
            sed 's/HTTP_STATUS:[0-9]*//' page_with_status.json > page.json
            
            # 调试输出状态码
            echo "Page $page HTTP status: $HTTP_STATUS"
            
            # 处理常见错误状态
            if [ "$HTTP_STATUS" -eq 403 ]; then
              echo "Error: API rate limited or insufficient permissions"
              break
            elif [ "$HTTP_STATUS" -eq 404 ]; then
              echo "Error: Repository not found (check repo path)"
              break
            elif [ "$HTTP_STATUS" -ne 200 ]; then
              echo "Error: Unexpected HTTP status $HTTP_STATUS"
              cat page.json  # 输出错误详情
              break
            fi

            # 验证响应是否为数组
            if ! jq -e 'type == "array"' page.json >/dev/null 2>&1; then
              echo "Stopping at page $page: Invalid array response"
              cat page.json  # 输出无效响应内容
              break
            fi

            len=$(jq 'length' page.json | tr -d '\n\r')
            echo "Page $page has $len contributors"
            if [ "$len" -eq 0 ]; then
              break
            fi

            jq -c '.[]' page.json >> contributors.json
            ((page++))
          done

          # 生成贡献者列表（放宽条件）
          jq -r '
            select(type == "object") | 
            if .login then "- [@\(.login)](https://github.com/\(.login))" 
            else "- Anonymous Contributor" 
            end
          ' contributors.json | sort -u > contributors.md

          # 确保至少有内容（即使API调用失败也显示维护者）
          if [ ! -s contributors.md ]; then
            echo "Warning: No contributors data found, using fallback"
            # 添加仓库主维护者（可手动修改为实际维护者）
            echo "- [@$(echo ${{ github.repository }} | cut -d/ -f1)](https://github.com/$(echo ${{ github.repository }} | cut -d/ -f1))" > contributors.md
          fi

          echo "Generated contributors list:"
          cat contributors.md

      - name: Inject into README.md
        run: |
          perl -0777 -pe '
            s/(<!--\s*readme: contributors -start\s*-->).*?(<!--\s*readme: contributors -end\s*-->)/$1\n'"$(cat contributors.md)"'\n$2/s
          ' README.md > README.md.tmp && mv README.md.tmp README.md

      - name: Inject into README_zh.md
        run: |
          perl -0777 -pe '
            s/(<!--\s*readme: contributors -start\s*-->).*?(<!--\s*readme: contributors -end\s*-->)/$1\n'"$(cat contributors.md)"'\n$2/s
          ' README_zh.md > README_zh.md.tmp && mv README_zh.md.tmp README_zh.md

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md README_zh.md
          git diff --cached --quiet || (
            git commit -m "docs: sync contributors [skip ci]" && git push
          )
